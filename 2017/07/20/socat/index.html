<!DOCTYPE html>
<html lang="zh-CN">
<head>

    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    
    
        <meta name="twitter:card" content="summary"/>
    



<meta name="twitter:title" content="Socat Command"/>
<meta name="twitter:description" content=""/>
<meta name="twitter:site" content="@"/>



  	<meta property="og:title" content="Socat Command &middot; Seacme Huang" />
  	<meta property="og:site_name" content="Seacme Huang" />
  	<meta property="og:url" content="http://huang901111.github.io/2017/07/20/socat/" />

    
        
            <meta property="og:image" content="http://oskduq7mi.bkt.clouddn.com/cover_polenord.jpg"/>
        
    

    
    <meta property="og:description" content="" />
  	<meta property="og:type" content="article" />
    <meta property="article:published_time" content="2017-07-20T00:00:00Z" />

    
    <meta property="article:tag" content="Linux" />
    
    

    <title>Socat Command &middot; Seacme Huang</title>

    
    <meta name="description" content="&lt;p&gt;&lt;left&gt;&lt;font color=#D3D3D3 size=5&gt;一个可以建立双向字节流并可以在其间传送数据的工具&lt;/font&gt;&lt;/left&gt; &lt;/p&gt;" />
    

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="shortcut icon" href="/images/favicon.ico">
	  <link rel="apple-touch-icon" href="/images/apple-touch-icon.png" />

    <link rel="stylesheet" type="text/css" href="/css/screen.css" />
    <link rel="stylesheet" type="text/css" href="/css/nav.css" />

    

    

    
      
          <link href="/index.xml" rel="alternate" type="application/rss+xml" title="Seacme Huang" />
      
      
    
    <meta name="generator" content="Hugo 0.24.1" />

    <link rel="canonical" href="http://huang901111.github.io/2017/07/20/socat/" />

    
      
    
    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": "",
        "logo": "http://huang901111.github.io/images/touxiang.png"
    },
    "author": {
        "@type": "Person",
        "name": "",
        
        "image": {
            "@type": "ImageObject",
            "url": "http://huang901111.github.io/images/touxiang.png",
            "width": 250,
            "height": 250
        }, 
        
        "url": "http://sa.seacme.cn",
        "sameAs": [
            
            
             
             
             
             
             
            
        ],
        "description": "Lifelong learning is the best investment for ourself life."
        
    },
    "headline": "Socat Command",
    "name": "Socat Command",
    "wordCount":  483 ,
    "timeRequired": "PT3M",
    "inLanguage": {
      "@type": "Language",
      "alternateName": "en"
    },
    "url": "http://huang901111.github.io/2017/07/20/socat/",
    "datePublished": "2017-07-20T00:00Z",
    "dateModified": "2017-07-20T00:00Z",
    
    "keywords": "Linux",
    "description": "",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "http://huang901111.github.io/2017/07/20/socat/"
    }
}
    </script>
    


    

    
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-79101-12', 'auto');
      ga('send', 'pageview');

    </script>
    

    




    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/styles/docco.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

</head>

<body class="nav-closed">

  <div class="nav">
    <h3 class="nav-title">Menu</h3>
    <a href="#" class="nav-close">
        <span class="hidden">Close</span>
    </a>
    <ul>
        
        
        
            
            <li class="nav-opened" role="presentation">
            	<a href="/">Blog</a>
            </li>
        
            
            <li class="nav-opened" role="presentation">
            	<a href="/tags/linux">Linux</a>
            </li>
        
            
            <li class="nav-opened" role="presentation">
            	<a href="/tags/database">Database</a>
            </li>
        
            
            <li class="nav-opened" role="presentation">
            	<a href="/tags/python">Python</a>
            </li>
        
            
            <li class="nav-opened" role="presentation">
            	<a href="/tags/network">Network</a>
            </li>
        
            
            <li class="nav-opened" role="presentation">
            	<a href="/tags/storage">Storage</a>
            </li>
        
            
            <li class="nav-opened" role="presentation">
            	<a href="/tags/windows">Windows</a>
            </li>
        
            
            <li class="nav-opened" role="presentation">
            	<a href="/tags/monitoring">Monitoring</a>
            </li>
        
            
            <li class="nav-opened" role="presentation">
            	<a href="/tags/interest">Interest</a>
            </li>
        
        
    </ul>

    
    <a class="subscribe-button icon-feed" href="/index.xml">Subscribe</a>
    
</div>
<span class="nav-cover"></span>


 <div class="site-wrapper">





<header class="main-header post-head no-cover">
  <nav class="main-nav clearfix">


  
      <a class="blog-logo" href="http://huang901111.github.io/"><img src="/images/touxiang.png" alt="Home" /></a>
  
  
      <a class="menu-button" href="#"><span class="burger">&#9776;</span><span class="word">Menu</span></a>
  
  </nav>
</header>



<main class="content" role="main">




  <article class="post post">

    <header class="post-header">
        <h1 class="post-title">Socat Command</h1>
        <small></small>

        <section class="post-meta">
        
          <time class="post-date" datetime="2017-07-20T00:00:00Z">
            Jul 20, 2017
          </time>
        
         
          <span class="post-tag small"><a href="http://huang901111.github.io/tags/linux/">#Linux</a></span>
         
        </section>
    </header>

    <section class="post-content">
      <p><left><font color=#D3D3D3 size=5>一个可以建立双向字节流并可以在其间传送数据的工具</font></left> </p>

<blockquote>
<p>一、Socat介绍</p>
</blockquote>

<ul>
<li><p><strong>概述</strong></p>

<ul>
<li><code>socat</code>，是Linux下的一个工具，其功能与有『瑞士军刀』之称的netcat类似。是一个可以建立双向字节流并可以在其间传送数据的工具。</li>
</ul></li>

<li><p><strong>特点</strong></p>

<ol>
<li><p><code>socat</code>是一个两个独立数据通道之间的双向数据传输的继电器。</p>

<p>a) 这些数据通道包含文件、管道、设备（终端或调制解调器）、插座（Unix、IPV4、IPV6、raw、UDP、TCP）、SSL、SOCKS4客户端或代理CONNECT</p></li>

<li><p><code>socat</code>支持广播和多播、抽象Unix sockets、Linux tun/tap、GNU readline和PTY。</p>

<p>b) 它提供了分叉、记录和进程间通信的不同模式。多个选项可用于调整socat和其渠道，socat可以作为TCP中继（一次性或守护进程），作为一个守护进程基于socksifier，作为一个shell unix套接字接口，作为IP6的继电器，或面向TCP的程序重定向到一个串行线。</p></li>

<li><p><code>socat</code>的主要特点就是在两个数据流之间建立通道；且支持众多协议和链接方式：ip、tcp、udp、ipv6、exec、system、open、proxy、openssl、socket等。</p></li>
</ol></li>
</ul>

<hr />

<blockquote>
<p>二、Socat的使用</p>
</blockquote>

<h4 id="2-1-部署">2.1 部署</h4>

<ul>
<li><p>直接采用yum方式安装</p>

<pre><code class="language-shell"># 安装epel源
wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-6.repo
# 采用yum方式安装
yum install socat
</code></pre></li>
</ul>

<h4 id="2-2-工作原理">2.2 工作原理</h4>

<ul>
<li><p><strong>4个阶段</strong></p>

<ol>
<li>*初始化*（解析命令行以及初始化日志系统）</li>
<li>*打开连接*（先打开第一个连接，再打开第二个连接。这个单步执行的。如果第一个连接失败，则会直接退出）</li>
<li>*数据转发*（谁有数据就转发到另外一个连接上，read/write互换）</li>
<li>*关闭*（其中一个连接掉开，执行处理另外一个连接）</li>
</ol></li>
</ul>

<h4 id="2-3-地址类型">2.3 地址类型</h4>

<p>参数由2部分组成，第一个连接和第二个连接，最简单的用法就是socat - - ，其效果就是输入什么，回显什么</p>

<p><strong>常用地址类型</strong></p>

<ol>
<li><p>TCP</p>

<pre><code class="language-shell"># 将目标机器目标端口的TCP协议流量转发到本地端口上
TCP:&lt;host&gt;:&lt;port&gt;[目标机器host][对应端口port]TCP-LISTEN:&lt;port&gt;[本机监听端口]
</code></pre></li>

<li><p>UDP</p>

<pre><code class="language-shell"># 将目标机器目标端口的UDP协议流量转发到本地端口上
UDP:&lt;host&gt;:&lt;port&gt;[目标机器host][目标端口port]UDP-LISTEN:&lt;port&gt;[本机监听端口]
</code></pre></li>

<li><p>OPENSSL</p></li>

<li><p>TUN</p>

<pre><code class="language-shell"># 建立VPN，双方都需要root权限
TUN[:&lt;if-addr&gt;/&lt;bits&gt;]
</code></pre></li>

<li><p>-，STDIN，STDOUT</p>

<ul>
<li>表示标准输入输出，可以就用一个横杠代替
<br /></li>
</ul></li>

<li><p>/var/log/syslog</p>

<ul>
<li>也可以是任意路径，打开一个文件作为数据流
<br /></li>
</ul></li>

<li><p>TCP-LISTEN</p>

<ul>
<li>建立TCP监听端口，TCP可以替换为UDP
<br /></li>
</ul></li>

<li><p>EXEC</p>

<ul>
<li>执行一个程序作为数据流</li>
</ul></li>
</ol>

<h4 id="2-4-基本语法">2.4 基本语法</h4>

<pre><code class="language-shell">socat [options] &lt;address&gt; &lt;address&gt;
</code></pre>

<ul>
<li>其中2个address就是关键，address就类似一个文件描述符，socat所做的工作就是在2个address指定的描述符间建立一个pipe用用发送和接手数据。
<br /></li>
</ul>

<hr />

<blockquote>
<p>三、Socat当Cat使用</p>
</blockquote>

<ul>
<li><strong>直接回显</strong></li>
</ul>

<pre><code class="language-shell">socat - -
</code></pre>

<ul>
<li><strong>scat文件</strong></li>
</ul>

<pre><code class="language-shell">socat - /data/backup/tmp/cfg.ini
;[common]
;pid = /var/run/falcon_eye/falcon_eye.pid

;[log]
;trace debug info warn error fetal
;level = info

[http]
port = 1990

;[collector]
;base_interval_in_seconds = 1
</code></pre>

<ul>
<li><strong>写文件</strong></li>
</ul>

<pre><code class="language-shell">echo &quot;test&quot; | socat - /data/backup/tmp/cfg.ini
socat - /data/backup/tmp/cfg.ini
;[common]
;pid = /var/run/falcon_eye/falcon_eye.pid

;[log]
;trace debug info warn error fetal
;level = info

[http]
port = 1990

;[collector]
;base_interval_in_seconds = 1
test
</code></pre>

<hr />

<blockquote>
<p>四、Socat当Netcat</p>
</blockquote>

<ul>
<li><strong>连接远程端口</strong></li>
</ul>

<pre><code class="language-shell">socat - TCP:xxx.xxx.xxx.xxx:80
</code></pre>

<ul>
<li><strong>监听端口</strong></li>
</ul>

<pre><code class="language-shell">socat TCP-LISTEN:80 - 
</code></pre>

<ul>
<li><strong>反向连接</strong></li>
</ul>

<pre><code class="language-shell"># server端：
socat tcp-listen:25 exec:/bin/bash,pty,stderr # 监听25端口
# client端：
socat readline tcp:192.168.141.126:25
# 通过25端口，连接到192.168.141.126上的/bin/bash
</code></pre>

<ul>
<li><strong>本地监听端口</strong></li>
</ul>

<pre><code class="language-shell">socat tcp-l:7777,reuseaddr,fork system:bash 
# 本地监听7777端口
</code></pre>

<ul>
<li><strong>向远处端口发送数据</strong></li>
</ul>

<pre><code class="language-shell">echo &quot;test&quot; | socat - tcp-connect:xxx.xxx.xxx.xxx:80
</code></pre>

<hr />

<blockquote>
<p>五、文件传递</p>
</blockquote>

<pre><code class="language-shell"># server端：
socat -u open:/data/backup/tmp/cfg.ini tcp-listen:8100
# client端：
socat -u tcp:192.168.141.126:8100 open:/data/backup/tmp/cfg3.ini,create
# 传输完毕后两端均退出
</code></pre>

<ul>
<li>-u：表示数据单项传送，从第一个参数传递到第二个参数</li>
<li>open：表示使用系统调用open()打开文件</li>
<li>tcp-listen：表示监听tcp端口</li>
<li>create：表示如果文件不存在则创建</li>
</ul>

<hr />

<blockquote>
<p>六、读写分离</p>
</blockquote>

<pre><code class="language-shell"># server端：
## 制作一个测试网页
echo &quot;aaa&quot; &gt; a.html
## 建立端口监听
socat open:a.html\!\!open:b.txt,create,append tcp-listen:12345,reuseaddr,fork
# client端：
curl http://192.168.141.126:12345
aaaaa
# server端：
## 检查日志写入
less b.txt
GET / HTTP/1.1
User-Agent: curl/7.19.7 (x86_64-redhat-linux-gnu) libcurl/7.19.7 NSS/3.21 Basic ECC zlib/1.2.3 libidn/1.18 libssh2/1.4.2
Host: 192.168.141.126:12345
Accept: */*
</code></pre>

<ul>
<li>open:a.html 表示读a.html文件</li>
<li>open:b.txt 表示收到的数据写入b.txt</li>
<li>reuseraddr 见socket的SO_REUSERADDR</li>
<li>fork 请求到达时，fork一个进程进行处理</li>
<li>在bash下，需要用\对！进行转义</li>
</ul>

<hr />

<blockquote>
<p>七、端口映射与转发</p>
</blockquote>

<ul>
<li><p><strong>断口映射与转发的区别</strong></p>

<ol>
<li>转发：你给我了，我打开看看，发现这上面的标志显示要给张三，那么我就给张三去。如果标志给李四，那我就再给李四去。</li>
<li>映射：你放到我左手，我就直接给张三；你放到我右手，我就直接给李四。这中间我不管你放我手上的是什么东西。</li>
<li>转发的重点在『转』上面。送快递的过来，把所有快递都交给门口保安，保安再根据每件快递上的收件人来分发。</li>
<li>映射，就是在大门口给每个人装个柜子，送快递的直接按收件人的名字，把快递放到对应的柜子里面。</li>
</ol></li>

<li><p><strong>端口映射</strong></p></li>
</ul>

<pre><code class="language-shell"># 外部机器
socat tcp-listen:1234 tcp-listen:3389
# 内部机器
socat tcp:outerhost:1234 tcp:192.168.141.126:3389
# 外部机器上的3389映射到内部网192.168.141.126的3389端口上
</code></pre>

<ul>
<li><strong>端口转发</strong></li>
</ul>

<pre><code class="language-shell"># TCP转发
socat TCP4-LISTEN:8888,reuseaddr,fork TCP4:xxx.xxx.xxx.xxx:80
## 本地监听8888端口，来自8888的连接重定向到目标xxx.xxx.xxx.xxx的80端口
## fork：设置多链接模式，即当一个链接被建立后，自动复制一个同样的端口再进行监听
## reuseaddr：绑定本地一个端口
# UDP转发
socat -T 600 UDP4-LISTEN:10000,reuseaddr,fork UDP4:1.1.1.1:10000 
## 本地监听10000端口，来自10000端口的连接重定向到目标1.1.1.1的10000端口
## -T：超时时间
</code></pre>

<hr />

<blockquote>
<p>八、实现VPN</p>
</blockquote>

<pre><code class="language-shell"># server端：
socat -d -d TCP-LISTEN:11443,reuseaddr TUN:192.168.255.1/24,up
# client端：
socat TCP:serverip:11443 TUN:192.168.255.2/24,up
</code></pre>

<hr />

<blockquote>
<p>九、通过Openssl来加密传输过程</p>
</blockquote>

<ul>
<li><p><strong>背景</strong></p>

<ul>
<li>当你想要在不同的机器上用socat进行数据传输，并且避免未被授权的程序存取，嗅探，数据伪造等等。需要加密这个交互过程。</li>
<li>为了解决这个问题，socat集成了OpenSSL链接库，并提供客户端和服务端的SSL功能。</li>
</ul></li>

<li><p><strong>生成服务端的证书</strong></p></li>
</ul>

<pre><code class="language-shell"># 为服务端的证书取一个名字
FILENAME=server
# 生成公钥私钥对
openssl genrsa -out ${FILENAME}.key 1024
# 生成一个自签名的证书
openssl req -new -key ${FILENAME}.key -x509 -days 3653 -out ${FILENAME}.crt
# 用刚生成的密钥文件和证书文件来生成PEM文件
cat ${FILENAME}.crt ${FILENAME}.crt &gt; ${FILENAME}.pem
# 修改私钥文件权限
chmod 600 ${FILENAME}.key ${FILENAME}.pem
# 复制${FILENAME}.crt证书文件到客户端
# 保留${FILENAME}.pem文件在服务端
</code></pre>

<ul>
<li><strong>生成客户端的证书</strong></li>
</ul>

<pre><code class="language-shell"># 为客户端的证书取一个名字
FILENAME=client
# 生成公钥私钥对
openssl genrsa -out ${FILENAME}.key 1024
# 生成一个自签名的证书
openssl req -new -key ${FILENAME}.key -x509 -days 3653 -out ${FILENAME}.crt
# 用刚生成的密钥文件和证书文件来生成PEM文件
cat ${FILENAME}.crt ${FILENAME}.crt &gt; ${FILENAME}.pem
# 修改私钥文件权限
chmod 600 ${FILENAME}.key ${FILENAME}.pem
# 复制${FILENAME}.crt证书文件到客户端
# 保留${FILENAME}.pem文件在服务端
</code></pre>

<p><strong>注意</strong>：</p>

<pre><code>1. 完成证书交换，服务端有（server.pem、client.crt）两个文件，客户端有（client.pem、server.crt）两个文件
</code></pre>

<ul>
<li><strong>使用</strong></li>
</ul>

<pre><code class="language-shell"># server端：
socat openssl-listen:4433,reuseaddr,cert=server.pem,cafile=client.crt system:bash,pty,stderr 
# client端：
socat readline openssl:xxx.xxx.xxx.xxx:4433,cert=client.pem,cafile=server.crt 
</code></pre>

<hr />

<blockquote>
<p>十、使用Socat监控Haproxy</p>
</blockquote>

<ul>
<li><strong>配置haproxy.cfg文件，加入设置状态</strong></li>
</ul>

<pre><code class="language-shell"># 修改haproxy配置文件
vim /etc/haproxy/haproxy.cfg
global
    log         127.0.0.1 local2
    chroot      /var/lib/haproxy
    pidfile     /var/run/haproxy.pid
    maxconn     6000
    user        haproxy
    group       haproxy
    daemon
    # 注释掉stats socket /var/lib/haproxy/stats 
    #stats socket /var/lib/haproxy/stats     
    stats socket /var/run/haproxy.sock mode 666 level admin
    stats timeout 2m
    
# 验证配置文件
haproxy -c -f /etc/haproxy/haproxy.cfg
# 重启haproxy
/etc/init.d/haproxy restart
# 检查socket文件
ll /var/run/haproxy.sock
srw-rw-rw- 1 root root 0 Sep 27 14:29 /var/run/haproxy.sock
</code></pre>

<ul>
<li><strong>常规使用</strong></li>
</ul>

<pre><code class="language-shell"># 检验帮助
echo &quot;show help&quot;|socat stdio unix-connect://var/run/haproxy.sock
# 对当前的haproxy进程信息打印报告
echo &quot;show info&quot;|socat stdio unix-connect://var/run/haproxy.sock
# 对当前haproxy各个指标打印报告
echo &quot;show stat&quot;|socat stdio unix-connect://var/run/haproxy.sock
</code></pre>

<ul>
<li><p><strong>haproxy 监控脚本</strong></p>

<ul>
<li><a href="http://www.cnblogs.com/MYSQLZOUQI/p/5809267.html">haproxy脚本链接</a></li>
</ul></li>
</ul>
    </section>


  <footer class="post-footer">


    
    <figure class="author-image">
        <a class="img" href="http://huang901111.github.io/" style="background-image: url(/images/touxiang.png)"><span class="hidden">Seacme Huang's Picture</span></a>
    </figure>
    

    





<section class="author">
  <h4><a href="http://huang901111.github.io/">Seacme Huang</a></h4>
  
  <p>Lifelong learning is the best investment for ourself life.</p>
  
  <div class="author-meta">
    <span class="author-location icon-location">GuangZhou, China</span>
    <span class="author-link icon-link"><a href="http://sa.seacme.cn">http://sa.seacme.cn</a></span>
  </div>
</section>



    
<section class="share">
  <h4>Share this post</h4>
  <a class="icon-twitter" style="font-size: 1.4em" href="https://twitter.com/share?text=Socat%20Command&nbsp;-&nbsp;Seacme%20Huang&amp;url=http%3a%2f%2fhuang901111.github.io%2f2017%2f07%2f20%2fsocat%2f"
      onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
      <span class="hidden">Twitter</span>
  </a>
  <a class="icon-facebook" style="font-size: 1.4em" href="https://www.facebook.com/sharer/sharer.php?u=http%3a%2f%2fhuang901111.github.io%2f2017%2f07%2f20%2fsocat%2f"
      onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
      <span class="hidden">Facebook</span>
  </a>
  <a class="icon-pinterest" style="font-size: 1.4em" href="http://pinterest.com/pin/create/button/?url=http%3a%2f%2fhuang901111.github.io%2f2017%2f07%2f20%2fsocat%2f&amp;description=Socat%20Command"
      onclick="window.open(this.href, 'pinterest-share','width=580,height=296');return false;">
      <span class="hidden">Pinterest</span>
  </a>
  <a class="icon-google-plus" style="font-size: 1.4em" href="https://plus.google.com/share?url=http%3a%2f%2fhuang901111.github.io%2f2017%2f07%2f20%2fsocat%2f"
     onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
      <span class="hidden">Google+</span>
  </a>
</section>



    


  </footer>
</article>

</main>


  <aside class="read-next">
  
      <a class="read-next-story" style="no-cover" href="/2017/07/20/pythonpyh/">
          <section class="post">
              <h2>Python PYH模块</h2>
              
          </section>
      </a>
  
  
      <a class="read-next-story prev" style="no-cover" href="/2017/07/20/tcpdump/">
          <section class="post">
              <h2>TCPdump Command</h2>
          </section>
      </a>
  
</aside>



    <footer class="site-footer clearfix">
        <section class="copyright"><a href="">Seacme Huang</a>  @ 2017</section>
        
        <section class="poweredby">Proudly generated by <a class="icon-hugo" href="http://gohugo.io">HUGO</a>, with <a class="icon-theme" href="https://github.com/vjeantet/hugo-theme-casper">Casper</a> theme</section>
        
    </footer>
    </div>
    <script type="text/javascript" src="/js/jquery.js"></script>
    <script type="text/javascript" src="/js/jquery.fitvids.js"></script>
    <script type="text/javascript" src="/js/index.js"></script>
    
</body>
</html>

